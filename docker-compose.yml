services:
  agent-mobile:
    build: .
    container_name: agent-mobile
    hostname: agent-mobile

    # Required for Tailscale
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    # Resource limits for predictable performance
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 512M

    volumes:
      # Persist Tailscale state (so you don't re-auth every restart)
      - tailscale-state:/var/lib/tailscale

      # Persist Claude config and auth
      - claude-config:/home/agent/.claude

      # Skills folder (optional - add skills here)
      - ./skills:/home/agent/.claude/skills

      # Persist user home for projects (bind mount for easy file access)
      - ./home:/home/agent/projects

      # Config directory (git, gh, etc.)
      - config:/home/agent/.config

      # SSH host keys (persist so clients don't need to re-accept)
      - ssh-keys:/etc/ssh/ssh_host_keys

      # TUN device for Tailscale
      - /dev/net/tun:/dev/net/tun

      # Corporate CA certificates
      - ./certs:/usr/local/share/ca-certificates/extra

    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - TAILSCALE_AUTHKEY=${TAILSCALE_AUTHKEY:-}
      - GIT_EMAIL=${GIT_EMAIL:-}
      - GIT_NAME=${GIT_NAME:-}
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-}
      # Node.js performance tuning
      - NODE_OPTIONS=--max-old-space-size=2048
      - UV_THREADPOOL_SIZE=8
      # Reduce file watcher CPU usage
      - CHOKIDAR_USEPOLLING=false
      # Skill system directory (for consistent paths in hooks and scripts)
      - SKILL_SYSTEM_DIR=/home/agent/.claude/skills

    # Not strictly needed with Tailscale, but useful for local testing
    ports:
      - "2222:22"

    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  tailscale-state:
  claude-config:
  config:
  ssh-keys:
