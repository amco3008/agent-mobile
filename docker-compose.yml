services:
  agent-mobile:
    build: .
    container_name: ${AGENT_NAME:-agent-mobile}
    hostname: ${AGENT_NAME:-agent-mobile}
    env_file: .env

    # Required for Tailscale
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    # Resource limits for predictable performance
    deploy:
      resources:
        limits:
          cpus: '${AGENT_CPUS:-2.0}'
          memory: ${AGENT_MEMORY:-3G}
        reservations:
          cpus: '${AGENT_RESERVATION_CPUS:-0.5}'
          memory: ${AGENT_RESERVATION_MEMORY:-512M}

    volumes:
      # Persist entire home directory (catch-all for any work outside ~/projects)
      - agent-home:/home/agent

      # Persist Tailscale state (so you don't re-auth every restart)
      - tailscale-state:/var/lib/tailscale

      # Persist Claude config and auth (overrides agent-home for this path)
      - claude-config:/home/agent/.claude

      # Skills folder (optional - add skills here)
      - ./skills:/home/agent/.claude/skills

      # Persist user home for projects (bind mount for easy file access)
      - ./home:/home/agent/projects

      # Config directory (git, gh, etc.)
      - config:/home/agent/.config

      # SSH host keys (persist so clients don't need to re-accept)
      - ssh-keys:/etc/ssh/ssh_host_keys

      # TUN device for Tailscale
      - /dev/net/tun:/dev/net/tun

      # Corporate CA certificates
      - ./certs:/usr/local/share/ca-certificates/extra

      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - TAILSCALE_AUTHKEY=${TAILSCALE_AUTHKEY:-}
      - GIT_EMAIL=${GIT_EMAIL:-}
      - GIT_NAME=${GIT_NAME:-}
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-}
      - TAILSCALE_EXIT_NODE=${TAILSCALE_EXIT_NODE:-}
      # Comma-separated domains to route through exit node (all other traffic bypasses it)
      # If not set, all traffic goes through exit node (default Tailscale behavior)
      - TAILSCALE_EXIT_NODE_ONLY=${TAILSCALE_EXIT_NODE_ONLY:-}
      # Node.js performance tuning
      - NODE_OPTIONS=--max-old-space-size=${AGENT_NODE_MEMORY:-2048}
      - UV_THREADPOOL_SIZE=8
      # Reduce file watcher CPU usage
      - CHOKIDAR_USEPOLLING=false
      # Skill system directory (for consistent paths in hooks and scripts)
      - SKILL_SYSTEM_DIR=/home/agent/.claude/skills
      # Claude Code max output tokens (default: 16000, max: 32000)
      - CLAUDE_CODE_MAX_OUTPUT_TOKENS=${CLAUDE_CODE_MAX_OUTPUT_TOKENS:-32000}
      # Push notification configuration (ntfy.sh)
      - NTFY_ENABLED=${NTFY_ENABLED:-false}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - NTFY_SERVER=${NTFY_SERVER:-https://ntfy.sh}
      - NTFY_RATE_LIMIT=${NTFY_RATE_LIMIT:-15}
      # Webtmux browser-based terminal (disabled by default to save CPU)
      - WEBTMUX_ENABLED=${WEBTMUX_ENABLED:-false}
      # Disable Claude Code auto-updater (use 'update-claude' command instead)
      - DISABLE_AUTOUPDATER=${DISABLE_AUTOUPDATER:-1}
      # Check for updates on container startup (after network ready)
      - CLAUDE_STARTUP_UPDATE=${CLAUDE_STARTUP_UPDATE:-true}
      # RTS Manager dashboard (Factorio-style control plane for Ralph loops)
      - RTS_ENABLED=${RTS_ENABLED:-true}
      - RTS_PORT=${RTS_PORT:-9091}
      - RTS_API_KEY=${RTS_API_KEY:-}
      # Clawdbot (Telegram/multi-platform AI assistant)
      - CLAWDBOT_ENABLED=${CLAWDBOT_ENABLED:-false}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # Clawd soul branch (default: master, set to switch personality/specialization)
      # Also controls clawdbot-config branch to isolate per-instance config
      - CLAWD_SOUL_BRANCH=${CLAWD_SOUL_BRANCH:-master}
      # Shared notes periodic sync interval in seconds (default: 300 = 5 min)
      - SHARED_NOTES_SYNC_INTERVAL=${SHARED_NOTES_SYNC_INTERVAL:-300}
      # Vercel CLI auth
      - VERCEL_TOKEN=${VERCEL_TOKEN:-}
      # Supabase CLI auth
      - SUPABASE_ACCESS_TOKEN=${SUPABASE_ACCESS_TOKEN:-}
      # Railway CLI auth
      - RAILWAY_TOKEN=${RAILWAY_TOKEN:-}

    # Not strictly needed with Tailscale, but useful for local testing
    ports:
      - "${AGENT_SSH_PORT:-2222}:22"
      - "${AGENT_WEB_PORT:-9090}:9090"
      - "${AGENT_RTS_PORT:-9091}:9091"
      - "${AGENT_CLAWDBOT_PORT:-18789}:18789"  # Clawdbot gateway

    restart: unless-stopped

    # Give container time to backup data on shutdown
    stop_grace_period: 30s

    # Health check
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  tailscale-state:
  claude-config:
  config:
  ssh-keys:
  agent-home:  # Persist entire home directory
